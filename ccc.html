<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>QR Attendance System</title>
<script src="https://unpkg.com/html5-qrcode"></script>

<style>
body {
  font-family: Courier;
  background-image: url("logo5.jpg");
  margin: 0;
  text-align: center;
  background-size: cover;
}

#reader {
  width: 300px;
  margin: 20px auto;
  background: white;
  padding: 10px;
  border-radius: 10px;
}

table {
  margin: 20px auto;
  width: 90%;
  border-collapse: collapse;
  background: white;
}

th { background: #5482e6; color: white; padding: 10px; }
td { border: 1px solid #ddd; padding: 8px; }

.present { background: #2ECC71; color: #166534; font-weight: bold; }
.late { background: darkgoldenrod; color: yellow; font-weight: bold; }
.absent { background: #fecaca; color: #7f1d1d; font-weight: bold; }

button {
  padding: 10px 20px;
  margin: 5px;
  background: green;
  color: white;
  border: none;
  border-radius: 5px;
  cursor: pointer;
}

.logout-btn { background: red; }

.modal {
  display: none;
  position: fixed;
  top:0;
  left:0;
  width:100%;
  height:100%;
  background: rgba(0,0,0,0.5);
  justify-content:center;
  align-items:center;
}

.modal-content {
  background:white;
  padding:20px;
  border-radius:8px;
  width:250px;
}
</style>
</head>

<body>

<h2>QR Attendance System</h2>

<div id="reader"></div>

<table id="attendanceTable">
<tr>
<th>Student Name</th>
<th>Date</th>
<th>Time</th>
<th>Status</th>
</tr>
</table>

<button onclick="exportToCSV()">â¬‡ Export to Excel</button>
<button onclick="markAllAbsent()">Mark Remaining as Absent</button>
<button class="logout-btn" onclick="showModal()">Logout</button>

<!-- Logout Modal -->
<div class="modal" id="logoutModal">
  <div class="modal-content">
    <h3>Logout?</h3>
    <button onclick="logout()">Yes</button>
    <button onclick="hideModal()">Cancel</button>
  </div>
</div>

<br><br>
<a href="https://quickchart.io/qr-code-api/" target="_blank">
Create QR Code for New Students
</a>

<script>

/* ================= STUDENT LIST ================= */
const students = {
  "104971140002": { name: "Amoranto Jaz Chine Kenth" },
  "158542150101": { name: "Angel Geliane Q." },
  "136473150058": { name: "Arago Chris Justin P." },
  "158538130309": { name: "Acibal Kc T." }
  // ðŸ‘‰ Add the rest of your students here
};

let scannedStudents = new Set();

/* ================= SCAN SUCCESS ================= */
function onScanSuccess(decodedText) {

  if (!students[decodedText]) {
    alert("Invalid QR Code!");
    return;
  }

  if (scannedStudents.has(decodedText)) {
    return;
  }

  scannedStudents.add(decodedText);

  let table = document.getElementById("attendanceTable");
  let row = table.insertRow(-1);

  let now = new Date();
  let presentCutoff = new Date();
  presentCutoff.setHours(6,30,0,0);

  let absentCutoff = new Date();
  absentCutoff.setHours(12,0,0,0);

  let status = "";
  let statusClass = "";

  if (now <= presentCutoff) {
    status = "Present";
    statusClass = "present";
  } else if (now < absentCutoff) {
    status = "Late";
    statusClass = "late";
  } else {
    status = "Absent";
    statusClass = "absent";
  }

  row.insertCell(0).innerText = students[decodedText].name;
  row.insertCell(1).innerText = now.toLocaleDateString();
  row.insertCell(2).innerText = now.toLocaleTimeString();

  let statusCell = row.insertCell(3);
  statusCell.innerText = status;
  statusCell.className = statusClass;
}

/* ================= INIT SCANNER ================= */
window.onload = function() {
  const html5QrCode = new Html5Qrcode("reader");

  Html5Qrcode.getCameras().then(devices => {
    if (devices.length) {
      html5QrCode.start(
        devices[0].id,
        { fps: 10, qrbox: 250 },
        onScanSuccess
      );
    }
  }).catch(err => {
    alert("Camera error or permission denied.");
    console.log(err);
  });
};

/* ================= MARK ABSENT ================= */
function markAllAbsent() {

  let table = document.getElementById("attendanceTable");
  let now = new Date();

  for (let id in students) {
    if (!scannedStudents.has(id)) {

      let row = table.insertRow(-1);

      row.insertCell(0).innerText = students[id].name;
      row.insertCell(1).innerText = now.toLocaleDateString();
      row.insertCell(2).innerText = "-";

      let statusCell = row.insertCell(3);
      statusCell.innerText = "Absent";
      statusCell.className = "absent";

      scannedStudents.add(id);
    }
  }
}

/* ================= EXPORT CSV ================= */
function exportToCSV() {

  let table = document.getElementById("attendanceTable");
  let csv = [];

  for (let i = 0; i < table.rows.length; i++) {
    let row = [];
    for (let j = 0; j < table.rows[i].cells.length; j++) {
      row.push('"' + table.rows[i].cells[j].innerText + '"');
    }
    csv.push(row.join(","));
  }

  let blob = new Blob([csv.join("\n")], { type: "text/csv;charset=utf-8;" });
  let link = document.createElement("a");
  link.href = URL.createObjectURL(blob);
  link.download = "Attendance.csv";
  document.body.appendChild(link);
  link.click();
  document.body.removeChild(link);
}

/* ================= LOGOUT ================= */
function showModal() {
  document.getElementById("logoutModal").style.display = "flex";
}

function hideModal() {
  document.getElementById("logoutModal").style.display = "none";
}

function logout() {
  sessionStorage.clear();
  localStorage.clear();
  window.location.href = "index.html";
}

</script>
</body>
</html>
